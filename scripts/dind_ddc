#!/bin/bash

set -e

# unset DOCKER_HOST to ensure we are not talking to a machine we shouldn't be
unset DOCKER_HOST

initialize() {
  # set default values; allow for override
  DIND_TAG="${DIND_TAG:-ee-17.03}"
  ENGINE_OPTS="${ENGINE_OPTS:-}"
  MANAGERS="${MANAGERS:-1}"
  WORKERS="${WORKERS:-2}"
  UCP_REPO="${UCP_REPO:-docker/ucp}"
  UCP_VERSION="${UCP_VERSION:-2.1.4}"
  UCP_IMAGES="${UCP_IMAGES:-${HOME}/ddc/ucp_images_"${UCP_VERSION}".tar.gz}"
  UCP_OPTIONS="${UCP_OPTIONS:-}"
  DTR_REPO="${DTR_REPO:-docker/dtr}"
  DTR_VERSION="${DTR_VERSION:-2.2.5}"
  DTR_IMAGES="${DTR_IMAGES:-${HOME}/ddc/dtr-"${DTR_VERSION}".tar.gz}"
  DDC_LICENSE="${DDC_LICENSE:-${HOME}/Downloads/docker_subscription.lic}"
  DIND_SUBNET="${DIND_SUBNET:-172.250.0.0/16}"
  DIND_DNS="${DIND_DNS:-8.8.8.8}"
  DIND_RESTART="${DIND_RESTART:-unless-stopped}"
  ALIAS_IP="${ALIAS_IP:-10.1.2.3}"

  # check to see what OS and set network interface
  if [ "$(uname -s)" = "Darwin" ]
  then
     NET_IF="${NET_IF:-en0}"
  else
     NET_IF="${NET_IF:-eth0}"
  fi

  # check for valid number of managers
  if ((MANAGERS<1))
  then
    echo "Error: The number of MANAGERS (${MANAGERS}) must be greater than 0"
    exit 1
  fi

  # check for valid number of workers
  if ((WORKERS<1))
  then
    echo "Warning: The number of WORKERS (${MANAGERS}) is less than 1; you will not be able to install DTR"
    sleep 5
  fi
}

env_info() {
  echo -e "DIND_TAG:\t${DIND_TAG}"
  echo -e "ENGINE_OPTS:\t${ENGINE_OPTS}"
  echo -e "MANAGERS:\t${MANAGERS}"
  echo -e "WORKERS:\t${WORKERS}"
  echo -e "UCP_REPO:\t${UCP_REPO}"
  echo -e "UCP_VERSION:\t${UCP_VERSION}"
  echo -e "UCP_IMAGES:\t${UCP_IMAGES}"
  echo -e "UCP_OPTIONS:\t${UCP_OPTIONS}"
  echo -e "DTR_REPO:\t${DTR_REPO}"
  echo -e "DTR_VERSION:\t${DTR_VERSION}"
  echo -e "DTR_IMAGES:\t${DTR_IMAGES}"
  echo -e "DDC_LICENSE:\t${DDC_LICENSE}"
  echo -e "DIND_SUBNET:\t${DIND_SUBNET}"
  echo -e "DIND_DNS:\t${DIND_DNS}"
  echo -e "DIND_RESTART:\t${DIND_RESTART}"
  echo -e "NET_IF:\t\t${NET_IF}"
  echo -e "ALIAS_IP:\t${ALIAS_IP}"
  exit 0
}

ddc_check_license() {
  if [ ! -f "${DDC_LICENSE}" ]
  then
    echo "Warning: Unable to find DDC_LICENSE (${DDC_LICENSE}); manually apply a license after installation"
    sleep 5
  else
    echo -e "Found DDC license '${DDC_LICENSE}'\n"
  fi
}

ucp_check_tar() {
  if [ ! -f "${UCP_IMAGES}" ]
  then
    echo "Error: Unable to find UCP_IMAGES"
    echo "Hint: try running '$0 ucp_create_tar' or download an offline tarball to '${UCP_IMAGES}'"
    exit 1
  else
    echo -e "Found UCP tarball '${UCP_IMAGES}'\n"
  fi
}

dtr_check_tar() {
  if [ ! -f "${DTR_IMAGES}" ]
  then
    echo "Error: Unable to find DTR_IMAGES"
    echo "Hint: try running '$0 dtr_create_tar' or download an offline tarball to '${DTR_IMAGES}'"
    exit 1
  else
    echo -e "Found DTR tarball '${DTR_IMAGES}'\n"
  fi
}

ucp_create_tar() {
  UCP_IMAGES_DIR="$(dirname "${UCP_IMAGES}")"
  if [ ! -d "${UCP_IMAGES_DIR}" ]
  then
    echo "Creating directory ${UCP_IMAGES_DIR}..."
    mkdir -p "${UCP_IMAGES_DIR}"
  fi

  if [ ! -f "${UCP_IMAGES}" ]
  then
    echo "Creating tarball of UCP images..."
    #shellcheck disable=SC2086 disable=SC2046
    {
      docker -H unix:///var/run/docker.sock run --rm "${UCP_REPO}":"${UCP_VERSION}" images --list ${UCP_OPTIONS} | xargs -L 1 docker -H unix:///var/run/docker.sock pull
      docker -H unix:///var/run/docker.sock save -o "${UCP_IMAGES}" $(docker -H unix:///var/run/docker.sock run --rm "${UCP_REPO}":"${UCP_VERSION}" images --list --image-version dev:) "${UCP_REPO}":"${UCP_VERSION}"
      docker -H unix:///var/run/docker.sock rmi $(docker -H unix:///var/run/docker.sock run --rm "${UCP_REPO}":"${UCP_VERSION}" images --list --image-version dev:) "${UCP_REPO}":"${UCP_VERSION}"
    }
    echo -e "done.\n"
  else
    echo "Error: Tarball of UCP images (${UCP_IMAGES}) already exists.  If you want to create a new tarball, please remove this file first"
    exit 1
  fi
}

dtr_create_tar() {
  DTR_IMAGES_DIR="$(dirname "${DTR_IMAGES}")"
  if [ ! -d "${DTR_IMAGES_DIR}" ]
  then
    echo "Creating directory ${DTR_IMAGES_DIR}..."
    mkdir -p "${DTR_IMAGES_DIR}"
  fi

  if [ ! -f "${DTR_IMAGES}" ]
  then
    echo "Creating tarball of DTR images..."
    #shellcheck disable=SC2046
    {
      docker -H unix:///var/run/docker.sock run --rm "${DTR_REPO}":"${DTR_VERSION}" images | xargs -L 1 docker -H unix:///var/run/docker.sock pull
      docker -H unix:///var/run/docker.sock save -o "${DTR_IMAGES}" $(docker -H unix:///var/run/docker.sock run --rm "${DTR_REPO}":"${DTR_VERSION}" images)
      docker -H unix:///var/run/docker.sock rmi $(docker -H unix:///var/run/docker.sock run --rm "${DTR_REPO}":"${DTR_VERSION}" images)
    }
    echo -e "done.\n"
  else
    echo "Error: Tarball of DTR images (${DTR_IMAGES}) already exists.  If you want to create a new tarball, please remove this file first"
    exit 1
  fi
}

create_net_alias() {
  # run this only on a mac
  if [ "$(uname -s)" = "Darwin" ]
  then
    # check to see if the default ALIAS_IP is set
    if [ "${ALIAS_IP}" = "10.1.2.3" ]
    then
      # check to see if the alias IP is already set
      if ! ifconfig "${NET_IF}" | grep "${ALIAS_IP}" > /dev/null 2>&1
      then
        # create it
        echo "Creating IP alias (requires sudo)..."
        sudo ifconfig "${NET_IF}" alias "${ALIAS_IP}" 255.255.255.0
        echo -e "done.\n"
      else
        # skip creation; already exists
        echo "IP alias (${ALIAS_IP}) already exists"
        echo -e "done.\n"
      fi
    else
      # skip because custom address provided
      echo "Skipping creation of network IP alias; custom address provided"
      echo -e "done.\n"
    fi
  else
    echo "Skipping creation of network IP alias; you're not on a Mac"

    # check to see if the default ALIAS_IP is set
    if [ "${ALIAS_IP}" = "10.1.2.3" ]
    then
      echo "ERROR: ALIAS_IP is not set; set to your host's IP address or installations will fail"
      exit 1
    fi
    echo -e "done.\n"
  fi
}

remove_net_alias() {
  # run this only on a mac
  if [ "$(uname -s)" = "Darwin" ]
  then
    # check to see if the default ALIAS_IP is set
    if [ "${ALIAS_IP}" = "10.1.2.3" ]
    then
      # check to see if the alias IP is already set
      if ifconfig "${NET_IF}" | grep "${ALIAS_IP}" > /dev/null 2>&1
      then
        # remove it
        echo "Removing IP alias (requires sudo)..."
        sudo ifconfig "${NET_IF}" -alias "${ALIAS_IP}" 255.255.255.0
        echo -e "done.\n"
      else
        # skip creation; already exists
        echo "IP alias (${ALIAS_IP}) does not exists; skipping removal"
        echo -e "done.\n"
      fi
    else
      # skip because custom address provided
      echo "Skipping removal of network IP alias; custom address provided"
      echo -e "done.\n"
    fi
  else
    echo "Skipping removal of network IP alias; you're not on a Mac"
    echo -e "done.\n"
  fi
}

create_all() {
  create_net_alias
  create_swarm
  install_ucp
  install_dtr
}

create_swarm() {
  launch_engines
  init_swarm
}

launch_engines() {
  # create dind network
  echo "Checking for subnet availability..."
  check_subnet
  echo -e "done.\n"

  echo "Creating 'dind' network with the subnet ${DIND_SUBNET}..."
  docker -H unix:///var/run/docker.sock network create --driver bridge --label project=dind_ddc --subnet="${DIND_SUBNET}" dind
  echo -e "done.\n"

  # get subnet prefix
  DIND_SUBNET_PREFIX="$(docker -H unix:///var/run/docker.sock network inspect --format '{{range .IPAM.Config}}{{.Subnet}}{{end}}' dind | awk -F '/' '{print $1}' | awk -F '.' '{print $1"."$2"."$3"."}')"

  NUM_NODES=$((MANAGERS+WORKERS))

  echo "Creating volumes for docker engines..."
  for ((ENGINE_NUM=1; ENGINE_NUM<=NUM_NODES; ENGINE_NUM++))
  do
    docker -H unix:///var/run/docker.sock volume create \
      --label project=dind_ddc \
      --driver local \
      docker${ENGINE_NUM}
  done
  echo -e "done.\n"

  echo "Launching ${NUM_NODES} docker engines..."
  # launch all docker engines
  for ((ENGINE_NUM=1; ENGINE_NUM<=NUM_NODES; ENGINE_NUM++))
  do
    #shellcheck disable=SC2086
    {
      docker -H unix:///var/run/docker.sock run -d \
        -p 127.0.0.1:100${ENGINE_NUM}:12375 \
        --name docker${ENGINE_NUM} \
        --hostname docker${ENGINE_NUM} \
        --label project=dind_ddc \
        --privileged \
        --net dind \
        --ip "${DIND_SUBNET_PREFIX}"$((ENGINE_NUM+51)) \
        --restart "${DIND_RESTART}" \
        -v /lib/modules:/lib/modules:ro \
        -v docker${ENGINE_NUM}:/var/lib/docker \
        --tmpfs /run \
        mbentley/docker-in-docker:"${DIND_TAG}" \
        dockerd -s overlay2 -H unix:///var/run/docker.sock -H tcp://0.0.0.0:12375 --dns "${DIND_DNS}" ${ENGINE_OPTS}
     }
  done
  echo -e "done.\n"
}

get_container_list() {
  docker ps -a --filter label=project=dind_ddc --format '{{.Names}}'
}

get_volume_list() {
  docker volume ls --filter label=project=dind_ddc --format '{{.Name}}'
}

get_network_list() {
  docker network ls --filter label=project=dind_ddc --format '{{.Name}}'
}

start_containers() {
  echo "Starting project containers..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock start $(get_container_list) || true
  echo -e "done.\n"
}

stop_containers() {
  echo "Stopping project containers; this may take up to 30 seconds..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock stop -t 30 $(get_container_list) || true
  echo -e "done.\n"
}

pause_containers() {
  echo "Pausing project containers..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock pause $(get_container_list) || true
  echo -e "done.\n"
}

unpause_containers() {
  echo "Unpausing project containers..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock unpause $(get_container_list) || true
  echo -e "done.\n"
}

recycle_containers() {
  stop_containers

  if [ "$(docker ps -a --filter label=project=dind_ddc --format '{{.Names}}' --filter name=ddc-lb)" = "ddc-lb" ]
  then
    RECREATE_LB=true
  else
    RECREATE_LB=false
  fi

  echo "Removing project containers..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock rm $(get_container_list) || true
  echo -e "done.\n"

  echo "Removing 'dind' network..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock network rm $(get_network_list) || true
  echo -e "done.\n"

  launch_engines
  if [ "${RECREATE_LB}" = "true" ]
  then
    launch_haproxy
  fi
}

project_status() {
  echo "Project containers:"
  docker ps -a --filter label=project=dind_ddc

  echo -e "\nProject volumes:"
  docker volume ls --filter label=project=dind_ddc

  echo -e "\nProject networks:"
  docker network ls --filter label=project=dind_ddc

  echo -e "\ndone.\n"
}

init_swarm() {
  echo "Initializing Swarm on docker1..."
  docker -H tcp://127.0.0.1:1001 swarm init
  echo -e "done.\n"

  # get swarm manager join token
  MANAGER_TOKEN=$(docker -H tcp://127.0.0.1:1001 swarm join-token manager -q)

  # get swarm worker join token
  WORKER_TOKEN=$(docker -H tcp://127.0.0.1:1001 swarm join-token worker -q)

  MANAGER_JOIN_COMMAND="swarm join --token ${MANAGER_TOKEN} $(docker -H unix:///var/run/docker.sock container inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' docker1):2377"

  WORKER_JOIN_COMMAND="swarm join --token ${WORKER_TOKEN} $(docker -H unix:///var/run/docker.sock container inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' docker1):2377"

  # join managers
  for ((ENGINE_NUM=2; ENGINE_NUM<=MANAGERS; ENGINE_NUM++))
  do
    echo "Joining docker${ENGINE_NUM} to the Swarm..."
    #shellcheck disable=SC2086
    docker -H tcp://127.0.0.1:100${ENGINE_NUM} ${MANAGER_JOIN_COMMAND}
    echo -e "done.\n"
  done

  # join workers
  for ((ENGINE_NUM=((MANAGERS+1)); ENGINE_NUM<=((MANAGERS+WORKERS)); ENGINE_NUM++))
  do
    echo "Joining docker${ENGINE_NUM} to the Swarm..."
    #shellcheck disable=SC2086
    docker -H tcp://127.0.0.1:100${ENGINE_NUM} ${WORKER_JOIN_COMMAND}
    echo -e "done.\n"
  done

  # output node info
  echo -e "Swarm mode cluster ready:"
  docker -H tcp://127.0.0.1:1001 node ls
  #shellcheck disable=SC2016
  echo -e "\nTo connect to the engine/Swarm, use:\neval "'"$(./dind_swarm connect_engine docker1)"'
  echo -e "done.\n"
}

connect_engine() {
  ENGINE_NUM="$(echo "${1}" | grep -o '[0-9]\+')"
  echo "# to connect to a given engine, use:"
  #shellcheck disable=SC2016
  echo '# eval "$(./dind_swarm connect_engine '"${1}"')"'
  echo "export DOCKER_HOST=tcp://127.0.0.1:100${ENGINE_NUM}"
}

install_ucp() {
  create_net_alias
  DOCKER1_IP="$(docker -H unix:///var/run/docker.sock container inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' docker1)"

  # load images on managers
  for ((ENGINE_NUM=1; ENGINE_NUM<=MANAGERS; ENGINE_NUM++))
  do
    echo "Loading UCP images for managers on docker${ENGINE_NUM}..."
    #shellcheck disable=SC2086
    docker -H tcp://127.0.0.1:100${ENGINE_NUM} load -i "${UCP_IMAGES}"
    echo -e "done.\n"
  done

  # load images on workers
  for ((ENGINE_NUM=((MANAGERS+1)); ENGINE_NUM<=((MANAGERS+WORKERS)); ENGINE_NUM++))
  do
    echo "Loading UCP images for workers on docker${ENGINE_NUM}..."
    #shellcheck disable=SC2086
    docker -H tcp://127.0.0.1:1001 save "${UCP_REPO}"-agent:"${UCP_VERSION}" | docker -H tcp://127.0.0.1:100${ENGINE_NUM} load || true
    docker -H tcp://127.0.0.1:1001 save "${UCP_REPO}"-hrm:"${UCP_VERSION}" | docker -H tcp://127.0.0.1:100${ENGINE_NUM} load || true
    echo -e "done.\n"
  done

  echo "Installing UCP on docker1..."
  #shellcheck disable=SC2086
  docker -H tcp://127.0.0.1:1001 run -it --rm --name ucp -v /var/run/docker.sock:/var/run/docker.sock "${UCP_REPO}":"${UCP_VERSION}" install ${UCP_OPTIONS} --admin-username admin --admin-password docker123 --host-address "${DOCKER1_IP}" --controller-port 4443 --san "${DOCKER1_IP}" --san "${ALIAS_IP}" --san "$(hostname)" --san "$(hostname -f)" --license "$(cat ${DDC_LICENSE})"

  launch_haproxy

  # add the ALIAS_IP to the SANs engine labels of the managers
  for ((ENGINE_NUM=2; ENGINE_NUM<=MANAGERS; ENGINE_NUM++))
  do
    echo "Adding UCP node label for SANs..."
    docker -H tcp://127.0.0.1:1001 node update --label-add "com.docker.ucp.SANs=$(docker -H tcp://127.0.0.1:1001 node inspect --format '{{(index .Spec.Labels "com.docker.ucp.SANs")}}' docker${ENGINE_NUM}),${ALIAS_IP}" docker${ENGINE_NUM}
    echo -e "done.\n"
  done

  echo "UCP should now be available at https://${ALIAS_IP}:4443/"
  echo -e "  Username: admin\tPassword: docker123"
  echo -e "done.\n"
}

launch_haproxy() {
  # get subnet prefix
  DIND_SUBNET_PREFIX="$(docker -H unix:///var/run/docker.sock network inspect --format '{{range .IPAM.Config}}{{.Subnet}}{{end}}' dind | awk -F '/' '{print $1}' | awk -F '.' '{print $1"."$2"."$3"."}')"

  echo -e "\nLaunching HAProxy (ddc-lb)..."
  docker -H unix:///var/run/docker.sock run -d \
    -p 80:80 \
    -p 443:443 \
    -p 4443:4443 \
    -p 8181:8181 \
    -p 8443:8443 \
    --name ddc-lb \
    --label project=dind_ddc \
    --net dind \
    --ip "${DIND_SUBNET_PREFIX}"$((MANAGERS+WORKERS+52)) \
    --restart=unless-stopped \
    -e MANAGERS="${MANAGERS}" \
    -e WORKERS="${WORKERS}" \
    mbentley/docker-in-docker:haproxy
  echo "The HAProxy stats page should now be available at http://${ALIAS_IP}:8181/haproxy?stats"
  echo -e "done.\n"
}

install_dtr() {
  DTR_NODE=$((MANAGERS+1))
  echo "Loading DTR images on docker${DTR_NODE}..."
  docker -H tcp://127.0.0.1:100${DTR_NODE} load -i "${DTR_IMAGES}"
  echo -e "done.\n"

  echo "Installing DTR on docker${DTR_NODE}..."
  docker -H tcp://127.0.0.1:100${DTR_NODE} run -it --rm "${DTR_REPO}":"${DTR_VERSION}" install --ucp-url https://"${ALIAS_IP}:4443" --ucp-username admin --ucp-password docker123 --ucp-node docker${DTR_NODE} --ucp-ca "$(curl -ks https://"${ALIAS_IP}":4443/ca)" --dtr-external-url "${ALIAS_IP}"

  echo -e "\nDTR should now be available at https://${ALIAS_IP}/"
  echo -e "  Username: admin\tPassword: docker123"
  echo -e "done.\n"
}

destroy_swarm() {
  echo "Removing project containers..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock kill $(get_container_list) || true
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock rm $(get_container_list) || true
  echo -e "done.\n"

  echo "Removing persistent data for docker engines (docker1, docker2, docker3)..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock volume rm $(get_volume_list) || true
  echo -e "done.\n"

  echo "Removing 'dind' network..."
  #shellcheck disable=SC2046
  docker -H unix:///var/run/docker.sock network rm $(get_network_list) || true
  echo -e "done.\n"

  remove_net_alias
}

check_subnet() {
  for i in $(docker -H unix:///var/run/docker.sock network ls -q)
  do
    if [ "$(docker -H unix:///var/run/docker.sock network inspect --format '{{range .IPAM.Config}}{{.Subnet}}{{end}}' "${i}")" = "${DIND_SUBNET}" ]
    then
      echo "ERROR: the subnet specified (${DIND_SUBNET}) for the 'dind' network conflicts with the existing network '$(docker -H unix:///var/run/docker.sock network inspect --format '{{.Name}}' "${i}")'"
      echo "Use DIND_SUBNET to specify a different subnet when launching a new environment"
      exit 1
    fi
  done

  echo "Subnet (${DIND_SUBNET}) is available."
}

main() {
  initialize

  case ${1} in
    create_all)
      ddc_check_license
      ucp_check_tar
      dtr_check_tar
      ${1}
      ;;
    install_ucp)
      ddc_check_license
      ucp_check_tar
      ${1}
      ;;
    install_dtr)
      dtr_check_tar
      ${1}
      ;;
    create_swarm|create_net_alias|remove_net_alias|destroy_swarm|ucp_create_tar|dtr_create_tar|env_info)
      ${1}
      ;;
    start|stop|pause|unpause|recycle)
      "${1}"_containers
      ;;
    connect_engine)
      if [ -z "${2}" ]
      then
        echo "Error: Missing engine name"
        echo "Usage: $0 connect_engine docker1"
      else
        ${1} "${2}"
      fi
      ;;
    status)
      project_status
      ;;
    *)
      echo "Basic usage: (see README.md for full command details)"
      echo -e "  $0 {create_all|create_swarm|install_ucp|install_dtr|destroy_swarm|env_info|status}"
      echo -e "\nContainer commands:"
      echo -e "  $0 {start|stop|pause|unpause|recycle}"
      echo -e "\nAdditional commands:"
      echo -e "  $0 {connect_engine|create_net_alias|remove_net_alias|ucp_create_tar|dtr_create_tar}"
      echo -e "\nCurrent set environment variables:"
      env_info
      ;;
  esac
}

main "${@}"
